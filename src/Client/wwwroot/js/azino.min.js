(function(){"use strict";function c(){const u=n&&n.JSModuleVersion?n.JSModuleVersion:"";if(!u)return e("Не установлен КриптоПро ЭЦП Browser plug-in");const r={cadesPluginApiVersion:u,browserPluginVersion:"",cspVersion:"",cspName:""};return new Promise(function(u,f){n.async_spawn(function*(u){try{i.oAbout||(i.oAbout=(yield n.CreateObjectAsync(t.OBJ.About)));const u=i.oAbout;r.cspName=(yield u.CSPName(80));r.cspVersion=(yield(yield u.CSPVersion("",80)).toString());r.browserPluginVersion=(yield(yield u.PluginVersion).toString())}catch(f){return u[1]("Ошибка чтения данных о CSP")}return console.log("About Crypto CSP :",r),u[0](r)},u,f)}).then(n=>f(n)).catch(n=>e(n))}function l(u=false){return!u&&r&&r.length>0?f(r):(r.length=0,i.oCerts.length=0,new Promise(function(u,f){n.async_spawn(function*(u){let f;try{if(!i.oStore&&(i.oStore=(yield n.CreateObjectAsync(t.OBJ.Store)),!i.oStore))return u[1]("Хранилище сертификатов не найдено");f=i.oStore;yield f.Open()}catch(h){return u[1]("Ошибка открытия хранилища сертификатов")}let e,s;try{e=(yield f.Certificates);s=(yield e.Count)}catch(h){return u[1]("Ошибка чтения сертификатов из хранилища")}for(let n=1;n<=s;n++){let u,t=ot();try{u=(yield e.Item(n))}catch(f){continue}try{t.ix=n-1;t.fromContainer=!1;let i=yield u.PublicKey(),r=yield i.Algorithm;t.publicKey={length:yield i.Length,key:yield(yield i.EncodedKey).Value(),parameters:yield(yield i.EncodedParameters).Value(),algorithm:yield r.FriendlyName,oid:yield r.Value};k(t.issuer,yield u.IssuerName);d(t.subject,yield u.SubjectName);t.type=t.subject.innLe?o.company:t.subject.org?o.organization:o.personal;t.serialNumber=(yield u.SerialNumber);t.thumbprint=(yield u.Thumbprint);t.fromDate=(yield u.ValidFromDate);t.tillDate=(yield u.ValidToDate);t.version=(yield u.Version);t.hasPrivateKey=(yield u.HasPrivateKey());t.isValid=(yield(yield u.IsValid()).Result);t.isCorrect=!!(t.hasPrivateKey&&t.subject.snils&&t.thumbprint);t.hasError=!1}catch(f){t.hasError=!0}r.push(t);i.oCerts.push(u)}return console.log("ALL CERTS: ",r),yield f.Close(),u[0](r)},u,f)}).then(n=>f(n)).catch(n=>e(n)))}function a(t,i=0){return new Promise(function(r,u){n.async_spawn(function*(r){let f=yield s(t,i);if(!f)return r[1]("Ошибка доступа к сертификату");let e=!1,u=yield f.PrivateKey;if(u){console.log("Private Key: ",u);try{let n=yield u.UniqueContainerName;console.log("PK Field: ",n);e=!!n}catch(o){return r[1]("Ошибка доступа к закрытому ключу: ",n.getLastError(o))}}return r[0](e)},r,u)}).then(n=>f(n)).catch(n=>e(n))}function v(n,t){return y(n,t).then(n=>f(n)).catch(n=>e(n))}function s(f,e=0){return new Promise(function(o,s){n.async_spawn(function*(o){var h,c;let s=null;if(u._thumbprint===f&&u._oCert)return o[0](u._oCert);if(i.oCerts){if(!e)for(let n=0;n<r.length;n++)if(r[n].Thumbprint===f){e=n;break}e&&(s=i.oCerts[e])}if(!s){let r;try{if(!i.oStore&&(i.oStore=(yield n.CreateObjectAsync(t.OBJ.Store)),!i.oStore))return console.warn("Хранилище сертификатов не найдено"),o[0](null);r=i.oStore;yield r.Open()}catch(l){return console.warn("Ошибка открытия хранилища сертификатов"),o[0](null)}let u=yield r.Certificates,e=yield u.Count;for(h=1;h<=e;h++){let t;try{t=(yield u.Item(h))}catch(i){return console.warn("Ошибка при получении сертификата: "+n.getLastError(i)),o[0](null)}try{if(c=(yield t.Thumbprint),f===c){s=t;break}}catch(i){return console.warn("Ошибка при получении отпечатка: "+n.getLastError(i)),o[0](null)}}r&&(yield r.Close())}return s?(u._thumbprint=f,u._oCert=s):(u._thumbprint="",u._oCert=null),o[0](s)},o,s)})}function y(i,r,u=""){return new Promise(function(f,e){n.async_spawn(function*(f){let l=yield s(i);if(!l)return f[1]("Ошибка доступа к сертификату");let e;try{if(e=(yield n.CreateObjectAsync(t.OBJ.CPSigner)),!e)return f[1]("Не удалось создать CAdESCOM.CPSigner")}catch(y){return f[1]("Ошибка обращения к CAdESCOM.CPSigner: "+y.number)}try{yield e.propset_Certificate(l);yield e.propset_Options(t.CAPICOM.CERTIFICATE_INCLUDE_WHOLE_CHAIN)}catch(y){return f[1]("Ошибка настройки CAdESCOM.CPSigner")}let p=new Date,o=yield n.CreateObjectAsync(t.OBJ.CPAttribute);yield o.propset_Name(t.CAPICOM.AUTHENTICATED_ATTRIBUTE_SIGNING_TIME);yield o.propset_Value(p);let h=yield n.CreateObjectAsync(t.OBJ.CPAttribute);yield h.propset_Name(t.CADESCOM.AUTHENTICATED_ATTRIBUTE_DOCUMENT_NAME);yield h.propset_Value(u);let a=yield e.AuthenticatedAttributes2;yield a.Add(o);yield a.Add(h);let c=yield n.CreateObjectAsync(t.OBJ.CadesSignedData);yield c.propset_ContentEncoding(t.CADESCOM.BASE64_TO_BINARY);yield c.propset_Content(r);let v="";try{let n=Date.now();v=(yield c.SignCades(e,t.CADESCOM.CADES_BES));let i=Date.now();console.warn("Время выполнения: "+(i-n)+" мс")}catch(w){let t=n.getLastError(w);return f[1]("Во время подписания произошла ошибка: "+t)}return f[0](v)},f,e)})}function p(n){return w(n)}function w(t){n.async_spawn(function*(t){var c=yield s(t[0]),v,i,r,a,f,e,o,u,h;console.log("Sign Cert: ",c);try{i="";try{r=(yield n.CreateObjectAsync("CAdESCOM.CPSigner"))}catch(l){i="Failed to create CAdESCOM.CPSigner: "+l.number;throw i;}if(a=new Date,f=(yield n.CreateObjectAsync("CADESCOM.CPAttribute")),yield f.propset_Name(0),yield f.propset_Value(a),e=(yield n.CreateObjectAsync("CADESCOM.CPAttribute")),yield e.propset_Name(1),yield e.propset_Value("Document Name"),o=(yield r.AuthenticatedAttributes2),yield o.Add(f),yield o.Add(e),r)yield r.propset_Certificate(c);else{i="Failed to create CAdESCOM.CPSigner";throw i;}u=(yield n.CreateObjectAsync("CAdESCOM.CadesSignedData"));h=window.fileContent;h&&(yield u.propset_ContentEncoding(1),yield u.propset_Content(h));yield r.propset_Options(1);try{console.time("Signing");console.log("oSigner:",r);console.log("oSignedData:",u);v=(yield u.SignCades(r,1,!0));console.timeEnd("Signing")}catch(l){i="Не удалось создать подпись из-за ошибки: "+n.getLastError(l);throw i;}}catch(l){}},t)}function f(n){return{succeed:!0,data:n,message:""}}function e(n){return{succeed:!1,data:null,message:n||"Ошибка"}}function b(n,t="|> ",i="info"){var r=i==="info"?console.info:i==="error"?console.error:i==="debug"?console.debug:i==="warn"?console.warn:console.log;r(t,n)}function k(n,t){let i=h(t);n.name=i.CN||"";n.inn=i.INN||"";n.ogrn=i.OGRN||"";n.eMail=i.E||""}function d(n,t){let i=h(t);n.surname=i.SN||"";n.givenName=i.G||"";n.title=i.T||"";n.inn=i.INN||i["ИНН"]||i["OID.1.2.643.3.131.1.1"]||"";n.snils=i.SNILS||i["СНИЛС"]||i["OID.1.2.643.100.3"]||"";n.org=i.O?i.O:"";n.ogrn=i.OGRN||i["ОГРН"]||i["OID.1.2.643.100.1"]||"";n.innLe=i.INNLE||i["ИНН ЮЛ"]||i["OID.1.2.643.100.4"]||"";n.name=i.CN||"";n.eMail=i.E||"";n.street="";n.locality=i.L||"";n.state=i.S||"";n.country=i.C||""}function h(n){let t=n.split(", "),i={};for(let n=0;n<t.length;n++){let r=t[n].split("=");r[0]&&(i[r[0]]=r[1]?r[1].replace(/(^")|("$)/g,"").replace(/""/g,'"').trim():"")}return i}function g(n,t,i){console.log("File: ",n,"\n",i);const f=new File([i],n,{type:t}),u=URL.createObjectURL(f),r=document.createElement("a");document.body.appendChild(r);r.href=u;r.download=n;r.target="_blank";r.click();URL.revokeObjectURL(u)}function nt(n){var t="data:"+n.mimeType+";base64,"+n.byteArray;fetch(t).then(n=>n.blob()).then(t=>{var i=window.document.createElement("a");i.href=window.URL.createObjectURL(t,{type:n.mimeType});i.download=n.fileName;document.body.appendChild(i);i.click();document.body.removeChild(i)})}function tt(n){document.getElementById(n).play()}function it(n){let t=document.getElementById(n);t.scrollTop=t.scrollHeight-t.clientHeight}function rt(){return Object.freeze({undefined:0,personal:1,organization:2,company:3})}function ut(){return{AUTHENTICATED_ATTRIBUTE_DOCUMENT_NAME:1,BASE64_TO_BINARY:1,CADES_BES:1}}function ft(){return{AUTHENTICATED_ATTRIBUTE_SIGNING_TIME:0,CERTIFICATE_INCLUDE_WHOLE_CHAIN:1,CURRENT_USER_STORE:2,MY_STORE:"My",STORE_OPEN_MAXIMUM_ALLOWED:2}}function et(){return{About:"CAdESCOM.About",CPAttribute:"CADESCOM.CPAttribute",CadesSignedData:"CAdESCOM.CadesSignedData",CPSigner:"CAdESCOM.CPSigner",Store:"CAdESCOM.Store"}}function ot(){return{ix:0,fromContainer:!1,hasError:!1,thumbprint:"",serialNumber:"",type:0,fromDate:null,tillDate:null,version:0,provider:"",privateKeyLink:"",hasPrivateKey:!1,isValid:!1,isCorrect:!1,publicKey:{algorithm:"",oid:"",key:"",parameters:"",length:0},subject:{surname:"",givenName:"",title:"",inn:"",snils:"",org:"",ogrn:"",innLe:"",name:"",eMail:"",street:"",locality:"",state:"",country:""},issuer:{name:"",inn:"",ogrn:"",eMail:""}}}var n;if(!window.azino){({cadesplugin:n})=window;n.then(function(){n.set_log_level(n.LOG_LEVEL_INFO)});var o=rt(),t={CADESCOM:ut(),CAPICOM:ft(),OBJ:et()},r=[],u={_oCert:null,_thumbprint:""},i={oAbout:null,oCerts:[],oStore:null};window.fileContent=null;window.azino={_store:{_certs:r,_usedLast:u},GetCryptoAbout:c,GetCertList:l,TokenCheck:a,SignCadesBES:v,SignCadesBES_Async:p,Console:b,LinkOpen:n=>window.open(n,"_blank","comma,delimited,list,of,window,features"),SaveFile:g,Download:nt,PlayAudio:tt,ScrollToBottom:it}}})();